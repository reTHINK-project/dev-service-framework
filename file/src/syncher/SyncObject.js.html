<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/syncher/SyncObject.js | Service Framework API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">bus</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Bus.js~Bus.html">Bus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MessageBus.js~MessageBus.html">MessageBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/MiniBus.js~MiniBus.html">MiniBus</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bus/Pipeline.js~Pipeline.html">Pipeline</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">discovery</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/discovery/Discovery.js~Discovery.html">Discovery</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">identity</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/Crypto.js~Crypto.html">Crypto</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/GuiFake.js~GuiFake.html">GuiFake</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/Identity.js~Identity.html">Identity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/IdentityModule.js~IdentityModule.html">IdentityModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/identity/OpenIdLib.js~OpenIdLib.html">OpenIdLib</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">syncher</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/DataObject.js~DataObject.html">DataObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/DataObjectChild.js~DataObjectChild.html">DataObjectChild</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/DataObjectObserver.js~DataObjectObserver.html">DataObjectObserver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/DataObjectReporter.js~DataObjectReporter.html">DataObjectReporter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/syncher/Syncher.js~Syncher.html">Syncher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ChangeType">ChangeType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ObjectType">ObjectType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ChangeType">ChangeType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ObjectType">ObjectType</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">utils</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/EventEmitter.js~EventEmitter.html">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/WatchingYou.js~WatchingYou.html">WatchingYou</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-checkAttribute">checkAttribute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-convertToUserURL">convertToUserURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-deepClone">deepClone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-divideEmail">divideEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-emptyObject">emptyObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUserEmailFromURL">getUserEmailFromURL</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getUserURLFromEmail">getUserURLFromEmail</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseAttributes">parseAttributes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-divideURL">divideURL</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/syncher/SyncObject.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
* Copyright 2016 PT Inova&#xE7;&#xE3;o e Sistemas SA
* Copyright 2016 INESC-ID
* Copyright 2016 QUOBIS NETWORKS SL
* Copyright 2016 FRAUNHOFER-GESELLSCHAFT ZUR FOERDERUNG DER ANGEWANDTEN FORSCHUNG E.V
* Copyright 2016 ORANGE SA
* Copyright 2016 Deutsche Telekom AG
* Copyright 2016 Apizee
* Copyright 2016 TECHNISCHE UNIVERSITAT BERLIN
*
* Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
**/

import {deepClone} from &apos;../utils/utils.js&apos;;

/**
 * @access private
 * Main class that maintains a JSON object, and observes changes in this object, recursively.
 * Internal objects and arrays are also observed.
 */
class SyncObject {
  /* private
    _data: any;
    _observers: ((event: ChangeEvent) =&gt; void)[]
  */

  constructor(initialData) {
    let _this = this;

    _this._observers = [];
    _this._filters = {};

    if (initialData) {
      _this._data = deepClone(initialData);
    } else {
      _this._data = {};
    }

    _this._internalObserve(new Path(), _this._data);
  }

  get data() { return this._data; }

  observe(callback) {
    this._observers.push(callback);
  }

  find(path) {
    let list = path.split(&apos;.&apos;);

    return this._findWithSplit(list);
  }

  findBefore(path) {
    let result = {};
    let list = path.split(&apos;.&apos;);
    result.last = list.pop();
    result.obj = this._findWithSplit(list);

    return result;
  }

  _findWithSplit(list) {
    let obj = this._data;
    list.forEach((value) =&gt; {
      obj = obj[value];
    });

    return obj;
  }

  _fireEvent(event) {
    this._observers.forEach((callback) =&gt; {
      callback(event);
    });
  }

  _isObservable(obj) {
    if (obj.constructor === Object || obj.constructor === Array) {
      return true;
    }

    return false;
  }

  _internalObserve(path, obj) {
    let _this = this;

    if (_this._isObservable(obj)) {
      let handler = (changes) =&gt; {
        _this._onChanges(path, changes);
      };

      if (obj.constructor === Object) {
        Object.observe(obj, handler);
        for (let prop in obj) {
          if (_this._isObservable(obj[prop])) {
            _this._internalObserve(path.new(prop), obj[prop]);
          }
        }
      } else if (obj.constructor === Array) {
        Array.observe(obj, handler);
        for (let prop in obj) {
          if (_this._isObservable(obj[prop])) {
            let np = path.new(new ArrayIndex(obj[prop], prop));
            _this._internalObserve(np, obj[prop]);
          }
        }
      }
    }
  }

  _onChanges(path, changes) {
    for (let i in changes) {
      let obj = changes[i].object;
      let objType;

      if (obj.constructor === Object) {
        objType = ObjectType.OBJECT;
      }

      if (obj.constructor === Array) {
        objType = ObjectType.ARRAY;
      }

      if (changes[i].type === &apos;splice&apos;) {
        let idx = changes[i].index;
        let field = path.new(&apos;&apos; + idx);
        let fieldString = field.toString();

        let removeSize = changes[i].removed.length;
        if (removeSize !== 0) {
          let removeValues = changes[i].removed;
          removeValues.forEach((value, index) =&gt; {
            if (this._isObservable(value)) {
              path.removeIndex(idx + index);
            }
          });

          this._fireEvent({
            cType: ChangeType.REMOVE,
            oType: objType,
            field: fieldString,
            data: removeSize
          });
        }

        let addSize = changes[i].addedCount;
        if (addSize !== 0) {
          let addValues = obj.slice(idx, idx + addSize);
          addValues.forEach((value, index) =&gt; {
            if (this._isObservable(value)) {
              let np = path.new(new ArrayIndex(value, idx + index));
              this._internalObserve(np, value);
            }
          });

          this._fireEvent({
            cType: ChangeType.ADD,
            oType: objType,
            field: fieldString,
            data: deepClone(addValues)
          });
        }

        //re-define paths...
        if (idx !== obj.length - 1) {
          path.reIndexFrom(obj);
        }
      } else {
        let field = path.new(changes[i].name);
        let fieldString = field.toString();

        if (fieldString.indexOf(&apos;Symbol&apos;) !== -1) {
          //hack for PhantomJS2
          //console.log(&apos;SYMBOL: &apos;, changes[i]);
          continue;
        }

        //let oldValue = changes[i].oldValue;
        let newValue = obj[changes[i].name];
        if (changes[i].type === &apos;update&apos;) {
          this._fireEvent({
            cType: ChangeType.UPDATE,
            oType: objType,
            field: fieldString,
            data: deepClone(newValue)
          });
        }

        if (changes[i].type === &apos;add&apos;) {
          this._internalObserve(field, newValue);
          this._fireEvent({
            cType: ChangeType.ADD,
            oType: objType,
            field: fieldString,
            data: deepClone(newValue)
          });
        }

        if (changes[i].type === &apos;delete&apos;) {
          this._fireEvent({
            cType: ChangeType.REMOVE,
            oType: objType,
            field: fieldString
          });
        }
      }
    }
  }
}

//dynamic path for Array index...
class Path {

  constructor() {
    this._path = [];
    this._observables = {}; //&lt;index:ArrayIndex&gt;
  }

  removeIndex(idx) {
    //console.log(&apos;REMOVE-PATH &apos; + idx);
    delete this._observables[idx];
  }

  reIndexFrom(array) {
    Object.keys(this._observables).forEach((key) =&gt; {
      let arrayIndex = this._observables[key];
      let idx = array.indexOf(arrayIndex.obj);
      if (arrayIndex.idx != idx) {
        //console.log(&apos;RE-INDEX: &apos; + key + &apos;-&gt;&apos; + idx);
        arrayIndex.idx = idx;
        delete this._observables[key];
        this._observables[idx] = arrayIndex;
      }
    });
  }

  new(idx) {
    if (idx.constructor == ArrayIndex) {
      //console.log(&apos;PATH-OBSERV: &apos;, idx);
      this._observables[idx.idx] = idx;
    }

    let nPath = this.clone();
    nPath._path.push(idx);

    return nPath;
  }

  clone() {
    let nPath = new Path();
    this._path.forEach((value) =&gt; {
      nPath._path.push(value);
    });

    return nPath;
  }

  toString() {
    //TODO: optimize!!
    let str = &apos;&apos;;
    this._path.forEach((value, index) =&gt; {
      if (index === 0) {
        str = value.toString();
      } else {
        str += &apos;.&apos; + value.toString();
      }
    });

    return str;
  }
}

class ArrayIndex {

  constructor(obj, idx) {
    this.obj = obj;
    this.idx = idx;
  }

  toString() {
    return this.idx.toString();
  }
}

export var ChangeType = {UPDATE: &apos;update&apos;, ADD: &apos;add&apos;, REMOVE: &apos;remove&apos;};
export var ObjectType = {OBJECT: &apos;object&apos;, ARRAY: &apos;array&apos;};
export default SyncObject;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
